version: '3.8'

services:
  carla-server:
    image: carlasim/carla:0.9.16
    container_name: carla-server
    ports:
      - "2000:2000"
      - "2001:2001"
      - "2002:2002"
    environment:
      - DISPLAY=
    command: /bin/bash -c "./CarlaUE4.sh -RenderOffScreen -quality-level=Low -nosound -carla-rpc-port=2000"
    networks:
      - carla-network
    healthcheck:
      test: ["CMD", "bash", "-c", "echo > /dev/tcp/localhost/2000"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 30s

  carla-client:
    image: carla-simple-client:latest
    container_name: carla-client
    depends_on:
      carla-server:
        condition: service_healthy
    command: carla-server 2000
    networks:
      - carla-network

networks:
  carla-network:
    driver: bridge
